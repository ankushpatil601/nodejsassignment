@Library('github.com/releaseworks/jenkinslib') _

pipeline{

agent any 

tools {nodejs "node"}

stages{
       stage("Cloning Repository"){
              steps{
                     cleanWs()
                  git 'https://github.com/ankushpatil601/nodejsassignment.git'
              }
      }
      stage("Install Dependencies"){
            steps{
              sh 'npm install'
            }
      }
      stage("Testing"){
            steps{
              sh 'npm test'
              
            }
        }      
       stage("creating build"){
              steps{
                 sh 'tar -cvzf nodejsapp-$BUILD_NUMBER.tar.gz .'
              }
              
        }
        
        stage("uploading to s3"){
               steps{
                 #  withCredentials([[$class: 'AmazonWebServicesCredentialsBinding', accessKeyVariable: 'AWS_ACCESS_KEY_ID', credentialsId: 's3deploy', secretKeyVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                  #       sh 'aws s3 ls'
                         
                         withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 's3deploy', usernameVariable: 'AWS_ACCESS_KEY_ID', passwordVariable: 'AWS_SECRET_ACCESS_KEY']]) {
                                   AWS("--region=ap-south-1 s3 ls")
                                   }
               #             }
               }
        
        }
        
        
      
}

}
